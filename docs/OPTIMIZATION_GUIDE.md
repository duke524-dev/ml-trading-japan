# Optimization Guide - å‚æ•°ä¼˜åŒ–æŒ‡å—

## å¿«é€Ÿå¼€å§‹

```python
from ml_framework import WalkForwardOptimizer

# 1. å®šä¹‰å‚æ•°ç©ºé—´
param_grid = {
    'profit_threshold': [0.05, 0.08, 0.10],
    'lookahead_bars': [15, 20, 30],
    'ml_confidence': [0.15, 0.20, 0.25],
    'tp_multiplier': [2.0, 3.0, 4.0],
    'sl_multiplier': [0.8, 1.0, 1.2],
    'trail_multiplier': [1.0, 1.2, 1.5]
}

# 2. è¿è¡Œä¼˜åŒ–
optimizer = WalkForwardOptimizer(n_splits=5, min_trades=10)
best = optimizer.optimize(df, param_grid)

# 3. æŸ¥çœ‹ç»“æœ
print(f"æœ€ä½³å¹³å‡ROI: {best['avg_roi']:.2f}%")
print(f"æœ€ä½³å‚æ•°: {best['params']}")
```

---

## å‚æ•°è¯¦è§£

### 1. profit_threshold (æ ‡ç­¾ç”Ÿæˆé˜ˆå€¼)

**å«ä¹‰**: å®šä¹‰"ç›ˆåˆ©"çš„æœ€å°ä»·æ ¼å˜åŠ¨æ¯”ä¾‹

**èŒƒå›´**: 0.03 - 0.15 (3% - 15%)

**å½±å“**:
- **åä½** (0.03-0.05): æ›´å¤šäº¤æ˜“ä¿¡å·ï¼Œä½†å™ªéŸ³å¤š
- **é€‚ä¸­** (0.06-0.10): å¹³è¡¡ä¿¡å·è´¨é‡å’Œæ•°é‡
- **åé«˜** (0.11-0.15): é«˜è´¨é‡ä¿¡å·ï¼Œä½†äº¤æ˜“æœºä¼šå°‘

**æ¨èèµ·ç‚¹**:
- 1åˆ†é’Ÿæ•°æ®: 0.003-0.005 (0.3%-0.5%)
- 5åˆ†é’Ÿæ•°æ®: 0.005-0.01 (0.5%-1%)
- æ—¥çº¿æ•°æ®: 0.05-0.10 (5%-10%)

---

### 2. lookahead_bars (å‰ç»Kçº¿æ•°)

**å«ä¹‰**: å‘å‰çœ‹å¤šå°‘æ ¹Kçº¿åˆ¤æ–­ç›ˆåˆ©

**èŒƒå›´**: 10 - 50

**å½±å“**:
- **åå°** (10-15): å¿«é€Ÿæ­¢ç›ˆï¼Œé€‚åˆçŸ­çº¿
- **é€‚ä¸­** (20-30): å¹³è¡¡æŒä»“æ—¶é—´
- **åå¤§** (40-50): æ•æ‰å¤§è¶‹åŠ¿ï¼Œä½†æŒä»“ä¹…

**æ¨èèµ·ç‚¹**:
- çŸ­çº¿ç­–ç•¥: 10-20
- ä¸­çº¿ç­–ç•¥: 20-40
- é•¿çº¿ç­–ç•¥: 40-60

---

### 3. ml_confidence (MLç½®ä¿¡åº¦é˜ˆå€¼)

**å«ä¹‰**: MLæ¨¡å‹é¢„æµ‹ç½®ä¿¡åº¦çš„æœ€ä½è¦æ±‚

**èŒƒå›´**: 0.15 - 0.40

**å½±å“**:
- **åä½** (0.15-0.20): æ›´å¤šäº¤æ˜“ï¼Œä½†å‡†ç¡®ç‡ä½
- **é€‚ä¸­** (0.20-0.30): å¹³è¡¡äº¤æ˜“æ•°å’Œå‡†ç¡®ç‡
- **åé«˜** (0.30-0.40): é«˜å‡†ç¡®ç‡ï¼Œä½†äº¤æ˜“å°‘

**æ¨èèµ·ç‚¹**:
- æ¿€è¿›ç­–ç•¥: 0.15-0.20
- ç¨³å¥ç­–ç•¥: 0.20-0.25
- ä¿å®ˆç­–ç•¥: 0.25-0.35

---

### 4. tp_multiplier (æ­¢ç›ˆå€æ•°)

**å«ä¹‰**: æ­¢ç›ˆç›®æ ‡ = entry_price Â± (tp_multiplier Ã— ATR)

**èŒƒå›´**: 1.5 - 5.0

**å½±å“**:
- **åå°** (1.5-2.5): å¿«é€Ÿæ­¢ç›ˆï¼Œé«˜èƒœç‡ï¼Œå°ç›ˆåˆ©
- **é€‚ä¸­** (2.5-3.5): å¹³è¡¡æ­¢ç›ˆé€Ÿåº¦å’Œç›ˆåˆ©
- **åå¤§** (3.5-5.0): å¤§ç›ˆåˆ©ï¼Œä½†å¸¸æå‰æ­¢æŸ

**æ¨èèµ·ç‚¹**:
- éœ‡è¡å¸‚: 2.0-2.5
- è¶‹åŠ¿å¸‚: 3.0-4.0
- å¼ºè¶‹åŠ¿: 4.0-5.0

---

### 5. sl_multiplier (æ­¢æŸå€æ•°)

**å«ä¹‰**: æ­¢æŸä½ = entry_price âˆ“ (sl_multiplier Ã— ATR)

**èŒƒå›´**: 0.5 - 2.0

**å½±å“**:
- **åå°** (0.5-0.8): ç´§æ­¢æŸï¼Œä½äºæŸï¼Œé«˜æ­¢æŸç‡
- **é€‚ä¸­** (0.8-1.2): å¹³è¡¡é£é™©å’Œæ­¢æŸç‡
- **åå¤§** (1.2-2.0): å®½æ­¢æŸï¼Œå¤§äºæŸï¼Œä½æ­¢æŸç‡

**æ¨èèµ·ç‚¹**:
- æ¿€è¿›ç­–ç•¥: 0.6-0.8
- ç¨³å¥ç­–ç•¥: 0.8-1.2
- ä¿å®ˆç­–ç•¥: 1.2-1.5

**å…³é”®**: sl_multiplier < tp_multiplier (ç›ˆäºæ¯” > 1)

---

### 6. trail_multiplier (è¿½è¸ªæ­¢æŸå€æ•°)

**å«ä¹‰**: è¿½è¸ªæ­¢æŸ = æœ€é«˜ä»·/æœ€ä½ä»· âˆ“ (trail_multiplier Ã— ATR)

**èŒƒå›´**: 0.8 - 2.5

**å½±å“**:
- **åå°** (0.8-1.2): ç´§è·Ÿä»·æ ¼ï¼Œæå‰é€€å‡º
- **é€‚ä¸­** (1.2-1.8): å¹³è¡¡ä¿æŠ¤å’Œç©ºé—´
- **åå¤§** (1.8-2.5): ç»™äºˆæ›´å¤šå›è°ƒç©ºé—´

**æ¨èèµ·ç‚¹**:
- çŸ­çº¿ç­–ç•¥: 1.0-1.5
- æ³¢æ®µç­–ç•¥: 1.5-2.0
- è¶‹åŠ¿ç­–ç•¥: 2.0-2.5

---

## ä¼˜åŒ–æµç¨‹

### Step 1: ç²—æœç´¢ (Coarse Search)

ä½¿ç”¨**å¤§æ­¥é•¿**å¿«é€Ÿæ‰¾åˆ°å¤§è‡´èŒƒå›´ï¼š

```python
param_grid_coarse = {
    'profit_threshold': [0.05, 0.10, 0.15],     # 3ä¸ªå€¼
    'lookahead_bars': [15, 30, 45],             # 3ä¸ªå€¼
    'ml_confidence': [0.15, 0.25, 0.35],        # 3ä¸ªå€¼
    'tp_multiplier': [2.0, 3.5, 5.0],           # 3ä¸ªå€¼
    'sl_multiplier': [0.7, 1.0, 1.3],           # 3ä¸ªå€¼
    'trail_multiplier': [1.0, 1.5, 2.0]         # 3ä¸ªå€¼
}
# æ€»ç»„åˆ: 3^6 = 729
```

**é¢„è®¡æ—¶é—´**: 2-4å°æ—¶

---

### Step 2: ç»†æœç´¢ (Fine Search)

åœ¨æœ€ä½³åŒºåŸŸé™„è¿‘ä½¿ç”¨**å°æ­¥é•¿**ç²¾ç»†æœç´¢ï¼š

```python
# å‡è®¾ç²—æœç´¢æœ€ä½³: profit_threshold=0.08
param_grid_fine = {
    'profit_threshold': [0.07, 0.08, 0.09],     # ç¼©å°èŒƒå›´
    'lookahead_bars': [18, 20, 22],
    'ml_confidence': [0.18, 0.20, 0.22],
    'tp_multiplier': [2.5, 3.0, 3.5],
    'sl_multiplier': [0.9, 1.0, 1.1],
    'trail_multiplier': [1.1, 1.2, 1.3]
}
# æ€»ç»„åˆ: 3^6 = 729
```

**é¢„è®¡æ—¶é—´**: 2-4å°æ—¶

---

### Step 3: éªŒè¯ (Validation)

åœ¨**ä¸åŒæ—¶é—´æ®µ**éªŒè¯æœ€ä½³å‚æ•°ï¼š

```python
# ä½¿ç”¨æœ€ä½³å‚æ•°åœ¨æ–°æ•°æ®ä¸Šæµ‹è¯•
best_params = {...}

# æµ‹è¯•ä¸åŒå¸‚åœºçŠ¶æ€
test_periods = [
    '2024-01-01:2024-03-31',  # Q1
    '2024-04-01:2024-06-30',  # Q2
    '2024-07-01:2024-09-30'   # Q3
]
```

**æ£€æŸ¥**:
- âœ… ROIåœ¨å„æ—¶æœŸéƒ½ > 0
- âœ… èƒœç‡æ³¢åŠ¨ < 10%
- âœ… æœ€å¤§å›æ’¤ < 15%

---

## å‚æ•°ç›¸å…³æ€§

### æ­£ç›¸å…³

| å‚æ•° 1 | å‚æ•° 2 | å…³ç³» |
|--------|--------|------|
| profit_threshold â†‘ | ml_confidence â†‘ | é«˜é˜ˆå€¼éœ€é«˜ç½®ä¿¡åº¦ |
| tp_multiplier â†‘ | trail_multiplier â†‘ | å¤§æ­¢ç›ˆéœ€å®½è¿½è¸ª |
| lookahead_bars â†‘ | tp_multiplier â†‘ | é•¿å‘¨æœŸéœ€å¤§æ­¢ç›ˆ |

### è´Ÿç›¸å…³

| å‚æ•° 1 | å‚æ•° 2 | å…³ç³» |
|--------|--------|------|
| sl_multiplier â†‘ | äº¤æ˜“é¢‘ç‡ â†“ | å®½æ­¢æŸå‡å°‘äº¤æ˜“ |
| ml_confidence â†‘ | äº¤æ˜“æ•°é‡ â†“ | é«˜ç½®ä¿¡åº¦ä¿¡å·å°‘ |

---

## è¯„ä¼°æŒ‡æ ‡ä¼˜å…ˆçº§

æ ¹æ®äº¤æ˜“ç›®æ ‡é€‰æ‹©ä¼˜åŒ–æŒ‡æ ‡ï¼š

### 1. è¿½æ±‚é«˜æ”¶ç›Š (Aggressive)
**ä¼˜å…ˆ**: avg_roi > profit_factor > total_trades
```python
best = max(results, key=lambda x: x['avg_roi'])
```

### 2. è¿½æ±‚ç¨³å®š (Stable)
**ä¼˜å…ˆ**: min_roi > std_roi > avg_roi
```python
best = max(results, key=lambda x: x['min_roi'] / (x['std_roi'] + 1e-6))
```

### 3. è¿½æ±‚ä½å›æ’¤ (Safe)
**ä¼˜å…ˆ**: avg_roi / max_drawdown > sharpe_ratio
```python
best = max(results, key=lambda x: x['avg_roi'] / (x['max_dd'] + 1e-6))
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¼˜åŒ–éœ€è¦å¤šé•¿æ—¶é—´ï¼Ÿ

**ç­”**: å–å†³äºï¼š
- æ•°æ®é‡: 10ä¸‡è¡Œçº¦1å°æ—¶
- å‚æ•°ç»„åˆ: 729ç»„çº¦2-4å°æ—¶
- CPUæ ¸å¿ƒæ•°: å¤šæ ¸å¯å¹¶è¡ŒåŠ é€Ÿ

**ä¼°ç®—å…¬å¼**: 
```
æ—¶é—´(å°æ—¶) â‰ˆ (æ•°æ®è¡Œæ•° / 100,000) Ã— (ç»„åˆæ•° / 729) Ã— 2
```

---

### Q2: å¦‚ä½•é¿å…è¿‡æ‹Ÿåˆï¼Ÿ

**ç­”**:
1. âœ… ä½¿ç”¨Walk-ForwardéªŒè¯ï¼ˆä¸æ˜¯ç®€å•K-Foldï¼‰
2. âœ… æ£€æŸ¥ä¸åŒFoldçš„ROIå·®å¼‚ < 50%
3. âœ… åœ¨æ ·æœ¬å¤–æ•°æ®éªŒè¯
4. âœ… é¿å…è¿‡å¤šå‚æ•°æœç´¢ï¼ˆ< 1000ç»„åˆï¼‰

---

### Q3: å‚æ•°åœ¨ä¸åŒå¸‚åœºé€‚ç”¨å—ï¼Ÿ

**ç­”**: 
- âŒ **ä¸é€‚ç”¨**: profit_threshold, lookahead_barsï¼ˆéœ€é‡æ–°ä¼˜åŒ–ï¼‰
- âœ… **å¯è¿ç§»**: ml_confidence, tp/sl/trailå€æ•°ï¼ˆå¯å¾®è°ƒï¼‰

**å»ºè®®**: æ¯ä¸ªå¸‚åœºå•ç‹¬ä¼˜åŒ–

---

### Q4: å¤šä¹…é‡æ–°ä¼˜åŒ–ä¸€æ¬¡ï¼Ÿ

**ç­”**:
- å¸‚åœºçŠ¶æ€å˜åŒ–ï¼ˆéœ‡è¡â†”è¶‹åŠ¿ï¼‰
- ç­–ç•¥ROIä¸‹é™ > 30%
- æ¯å­£åº¦ï¼ˆ3ä¸ªæœˆï¼‰ä¾‹è¡Œæ£€æŸ¥

---

## å®æˆ˜æ¡ˆä¾‹

### TOPIXä¼˜åŒ–å†ç¨‹

#### ç¬¬1è½®: åŸºçº¿å‚æ•°
```python
params = {
    'profit_threshold': 0.05,
    'lookahead_bars': 20,
    'ml_confidence': 0.20,
    'tp_multiplier': 2.5,
    'sl_multiplier': 1.0,
    'trail_multiplier': 1.5
}
# ç»“æœ: ROI = 6.28%
```

#### ç¬¬2è½®: ç²—æœç´¢
```python
# 729ç»„åˆæœç´¢
# å‘ç°æœ€ä½³åŒºåŸŸ: profit_threshold=0.08, tp_multiplier=3.0
# ç»“æœ: ROI = 52.34%
```

#### ç¬¬3è½®: ç»†æœç´¢
```python
# æœ€ç»ˆä¼˜åŒ–å‚æ•°
best_params = {
    'profit_threshold': 0.08,
    'lookahead_bars': 20,
    'ml_confidence': 0.20,
    'tp_multiplier': 3.0,
    'sl_multiplier': 1.0,
    'trail_multiplier': 1.2
}
# ç»“æœ: ROI = 72.56% âœ…
```

**æ”¹è¿›**: 6.28% â†’ 72.56% = **11.6å€æå‡ï¼**

---

## å·¥å…·å’Œè„šæœ¬

### è¿è¡Œå®Œæ•´ä¼˜åŒ–

```bash
python examples/run_optimization.py
```

### æŸ¥çœ‹Top 10å‚æ•°

```python
top_10 = optimizer.get_top_n(10)
for i, result in enumerate(top_10, 1):
    print(f"Rank {i}: ROI={result['avg_roi']:.2f}%")
```

### ä¿å­˜ç»“æœ

```python
optimizer.save_results('results/optimization_results.json')
```

### å¯è§†åŒ–ç»“æœ

```python
optimizer.plot_results(top_n=20, save_path='visualizations/optimization.png')
```

---

**ç¥ä¼˜åŒ–é¡ºåˆ©ï¼Happy Tuning! ğŸ¯**
